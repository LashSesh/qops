import{get_request_store as g,with_request_store as U}from"@sveltejs/kit/internal/server";import{parse as J}from"devalue";import{error as S,json as N}from"@sveltejs/kit";import{b as k,f as A,e as B,n as H,g as L,h as M,s as V,a as z,c as D}from"./chunks/shared.js";import{ValidationError as F}from"@sveltejs/kit/internal";import{b as G,c as K,p as I}from"./chunks/environment.js";function R(s,t){if(!t)return n=>{n!==void 0&&S(400,"Bad Request")};if(s==="unchecked")return n=>n;if("~standard"in s)return async n=>{const{event:e,state:r}=g(),a=await s["~standard"].validate(n);return a.issues&&S(400,await r.handleValidationError({issues:a.issues,event:e})),a.value};throw new Error('Invalid validator passed to remote function. Expected "unchecked" or a Standard Schema (https://standardschema.dev)')}async function q(s,t,n,e){var a,i;await 0;const r=O(s,n);return(i=r[a=k(t,n.transport)])!=null?i:r[a]=e()}function Q(s,t){const n={};for(const e in t)n[e]=t[e].decode;return J(s,n)}async function j(s,t,n,e,r,a){const i={event:{...s,setHeaders:()=>{throw new Error("setHeaders is not allowed in remote functions")},cookies:{...s.cookies,set:(f,o,d)=>{if(!n)throw new Error("Cannot set cookies in `query` or `prerender` functions");if(d.path&&!d.path.startsWith("/"))throw new Error("Cookies set in remote functions must have an absolute path");return s.cookies.set(f,o,d)},delete:(f,o)=>{if(!n)throw new Error("Cannot delete cookies in `query` or `prerender` functions");if(o.path&&!o.path.startsWith("/"))throw new Error("Cookies deleted in remote functions must have an absolute path");return s.cookies.delete(f,o)}}},state:{...t,is_in_remote_function:!0}},u=await U(i,()=>r(e));return U(i,()=>a(u))}function O(s,t=g().state){var e,r;let n=(e=t.remote_data)==null?void 0:e.get(s);return n===void 0&&(n={},((r=t.remote_data)!=null?r:t.remote_data=new Map).set(s,n)),n}function ie(s,t){const n=t!=null?t:s,e=R(s,t),r={type:"command",id:"",name:""},a=i=>{var d;const{event:u,state:f}=g();if(f.is_endpoint_request){if(!["POST","PUT","PATCH","DELETE"].includes(u.request.method))throw new Error(`Cannot call a command (\`${r.name}(${t?"...":""})\`) from a ${u.request.method} handler`)}else if(!u.isRemoteRequest)throw new Error(`Cannot call a command (\`${r.name}(${t?"...":""})\`) during server-side rendering`);(d=f.refreshes)!=null||(f.refreshes={});const o=Promise.resolve(j(u,f,!0,i,e,n));return o.updates=()=>{throw new Error(`Cannot call '${r.name}(...).updates(...)' on the server`)},o};return Object.defineProperty(a,"__",{value:r}),Object.defineProperty(a,"pending",{get:()=>0}),a}function ce(s,t){const n=t!=null?t:s,e=!t||s==="unchecked"?null:s;function r(a){const i={};i.method="POST",Object.defineProperty(i,"enhance",{value:()=>({action:i.action,method:i.method})});const u={type:"submit",onclick:()=>{}};Object.defineProperty(u,"enhance",{value:()=>({type:"submit",formaction:i.buttonProps.formaction,onclick:()=>{}})}),Object.defineProperty(i,"buttonProps",{value:u});const f={type:"form",name:"",id:"",fn:async(o,d,l)=>{var w,v,P,_,$;const c={};c.submission=!0;const{event:p,state:m}=g(),h=await(e==null?void 0:e["~standard"].validate(o));if(d.validate_only)return(v=(w=h==null?void 0:h.issues)==null?void 0:w.map(E=>H(E,!0)))!=null?v:[];if((h==null?void 0:h.issues)!==void 0)W(c,h.issues,l);else{h!==void 0&&(o=h.value),(P=m.refreshes)!=null||(m.refreshes={});const E=X();try{c.result=await j(p,m,!0,o,y=>y,y=>t?n(y,E):n())}catch(y){if(y instanceof F)W(c,y.issues,l);else throw y}}return p.isRemoteRequest||($=(_=O(f,m))[""])!=null||(_[""]=c),c}};return Object.defineProperty(i,"__",{value:f}),Object.defineProperty(i,"action",{get:()=>`?/remote=${f.id}`,enumerable:!0}),Object.defineProperty(u,"formaction",{get:()=>`?/remote=${f.id}`,enumerable:!0}),Object.defineProperty(i,"fields",{get(){var l,c;const o=(l=O(f))==null?void 0:l[""],d=A((c=o==null?void 0:o.issues)!=null?c:[]);return B({},()=>{var p;return(p=o==null?void 0:o.input)!=null?p:{}},(p,m)=>{var w,v,P;if(o!=null&&o.submission)return;const h=p.length===0?m:M((w=o==null?void 0:o.input)!=null?w:{},p.map(String),m);((P=(v=O(f))[""])!=null?P:v[""]={}).input=h},()=>d)}}),Object.defineProperty(i,"result",{get(){var o,d;try{return(d=(o=O(f))==null?void 0:o[""])==null?void 0:d.result}catch{return}}}),Object.defineProperty(i,"pending",{get:()=>0}),Object.defineProperty(u,"pending",{get:()=>0}),Object.defineProperty(i,"preflight",{value:()=>i}),Object.defineProperty(i,"validate",{value:()=>{throw new Error("Cannot call validate() on the server")}}),a==null&&Object.defineProperty(i,"for",{value:o=>{var p;const{state:d}=g(),l=f.id+"|"+JSON.stringify(o);let c=((p=d.form_instances)!=null?p:d.form_instances=new Map).get(l);return c||(c=r(o),c.__.id=`${f.id}/${encodeURIComponent(JSON.stringify(o))}`,c.__.name=f.name,d.form_instances.set(l,c)),c}}),i}return r()}function W(s,t,n){if(s.issues=t.map(e=>H(e,!0)),n){s.input={};for(let e of n.keys()){if(/^[.\]]?_/.test(e))continue;const r=e.endsWith("[]"),a=n.getAll(e).filter(i=>typeof i=="string");r&&(e=e.slice(0,-2)),L(s.input,e,r?a:a[0])}}}function X(){return new Proxy(n=>{if(typeof n!="string")throw new Error("`invalid` should now be imported from `@sveltejs/kit` to throw validation issues. The second parameter provided to the form function (renamed to `issue`) is still used to construct issues, e.g. `invalid(issue.field('message'))`. For more info see https://github.com/sveltejs/kit/pulls/14768");return s(n)},{get(n,e){return typeof e=="symbol"?n[e]:t(e,[])}});function s(n,e=[]){return{message:n,path:e}}function t(n,e){const r=[...e,n],a=i=>s(i,r);return new Proxy(a,{get(i,u){return typeof u=="symbol"?i[u]:/^\d+$/.test(u)?t(parseInt(u,10),r):t(u,r)}})}}function ue(s,t,n){const e=typeof t=="function"?t:void 0,r=n!=null?n:e?void 0:t,a=e!=null?e:s,i=R(s,e),u={type:"prerender",id:"",name:"",has_arg:!!e,inputs:r==null?void 0:r.inputs,dynamic:r==null?void 0:r.dynamic},f=o=>{const d=(async()=>{var P;const{event:l,state:c}=g(),p=k(o,c.transport),m=u.id,h=`${G}/${K}/remote/${m}${p?`/${p}`:""}`;if(!c.prerendering&&!z&&!l.isRemoteRequest)try{return await q(u,o,c,async()=>{var y;const _=k(o,c.transport),$=O(u,c),E=(y=$[_])!=null?y:$[_]=fetch(new URL(h,l.url.origin).href).then(async T=>{if(!T.ok)throw new Error("Prerendered response not found");const b=await T.json();return b.type==="error"&&S(b.status,b.error),b.result});return Q(await E,c.transport)})}catch{}if((P=c.prerendering)!=null&&P.remote_responses.has(h))return c.prerendering.remote_responses.get(h);const w=q(u,o,c,()=>j(l,c,!1,o,i,a));c.prerendering&&c.prerendering.remote_responses.set(h,w);const v=await w;if(c.prerendering){const _={type:"result",result:V(v,c.transport)};c.prerendering.dependencies.set(h,{body:JSON.stringify(_),response:N(_)})}return v})();return d.catch(()=>{}),d};return Object.defineProperty(f,"__",{value:u}),f}function Y(s,t){const n=t!=null?t:s,e=R(s,t),r={type:"query",id:"",name:""},a=i=>{if(I)throw new Error(`Cannot call query '${r.name}' while prerendering, as prerendered pages need static data. Use 'prerender' from $app/server instead`);const{event:u,state:f}=g(),o=()=>j(u,f,!1,i,e,n),d=q(r,i,f,o);return d.catch(()=>{}),d.set=l=>x(C(r,"set",i),l),d.refresh=()=>{const l=C(r,"refresh",i),c=!l.cache[l.cache_key],p=c?d:o();return x(l,p,c)},d.withOverride=()=>{throw new Error(`Cannot call '${r.name}.withOverride()' on the server`)},d};return Object.defineProperty(a,"__",{value:r}),a}function Z(s,t){const n=t!=null?t:s,e=R(s,t),r={type:"query_batch",id:"",name:"",run:u=>{const{event:f,state:o}=g();return j(f,o,!1,u,d=>Promise.all(d.map(e)),n)}};let a={args:[],resolvers:[]};const i=u=>{if(I)throw new Error(`Cannot call query.batch '${r.name}' while prerendering, as prerendered pages need static data. Use 'prerender' from $app/server instead`);const{event:f,state:o}=g(),d=()=>new Promise((c,p)=>{a.args.push(u),a.resolvers.push({resolve:c,reject:p}),!(a.args.length>1)&&setTimeout(async()=>{const m=a;a={args:[],resolvers:[]};try{const h=await j(f,o,!1,m.args,w=>Promise.all(w.map(e)),n);for(let w=0;w<m.resolvers.length;w++)try{m.resolvers[w].resolve(h(m.args[w],w))}catch(v){m.resolvers[w].reject(v)}}catch(h){for(const w of m.resolvers)w.reject(h)}},0)}),l=q(r,u,o,d);return l.catch(()=>{}),l.set=c=>x(C(r,"set",u),c),l.refresh=()=>{const c=C(r,"refresh",u),p=!c.cache[c.cache_key],m=p?l:d();return x(c,m,p)},l.withOverride=()=>{throw new Error(`Cannot call '${r.name}.withOverride()' on the server`)},l};return Object.defineProperty(i,"__",{value:r}),i}Object.defineProperty(Y,"batch",{value:Z,enumerable:!0});function C(s,t,n){const{state:e}=g(),{refreshes:r}=e;if(!r){const f=s.type==="query_batch"?`query.batch '${s.name}'`:`query '${s.name}'`;throw new Error(`Cannot call ${t} on ${f} because it is not executed in the context of a command/form remote function`)}const a=O(s,e),i=k(n,e.transport),u=D(s.id,i);return{__:s,state:e,refreshes:r,refreshes_key:u,cache:a,cache_key:i}}function x({__:s,refreshes:t,refreshes_key:n,cache:e,cache_key:r},a,i=!1){const u=Promise.resolve(a);return i||(e[r]=u),s.id&&(t[n]=u),u.then(()=>{})}export{ie as command,ce as form,ue as prerender,Y as query};
